<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Spotify Shuffle Queue</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
  button { padding: 1em 2em; font-size: 1.2em; }
  .success { background-color: green; color: white; }
  .error { background-color: red; color: white; }
</style>
</head>
<body>

<h1>Spotify Shuffle Queue</h1>
<button id="loginBtn">Login with Spotify</button>
<button id="shuffleBtn" style="display:none;">Shuffle</button>

<script>
/* ---------------- CONFIG ---------------- */
const clientId = "f2b3fb7dabb945c0b6938aa0d10dc295"; // From Spotify Dashboard
const redirectUri = window.location.origin + window.location.pathname; // This page's URL
const playlistId = "1IhKWSnFKpEn5FZgEnk5uO";
const scopes = "user-modify-playback-state";

/* --------- HELPER: PKCE Generator --------- */
function generateCodeVerifier(length) {
  let text = '';
  let possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  for (let i = 0; i < length; i++) {
    text += possible.charAt(Math.floor(Math.random() * possible.length));
  }
  return text;
}

async function generateCodeChallenge(codeVerifier) {
  const data = new TextEncoder().encode(codeVerifier);
  const digest = await crypto.subtle.digest('SHA-256', data);
  return btoa(String.fromCharCode(...new Uint8Array(digest)))
    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

/* --------- AUTHENTICATION FLOW --------- */
async function loginWithSpotify() {
  const codeVerifier = generateCodeVerifier(128);
  const codeChallenge = await generateCodeChallenge(codeVerifier);

  localStorage.setItem('code_verifier', codeVerifier);

  const args = new URLSearchParams({
    response_type: 'code',
    client_id: clientId,
    scope: scopes,
    redirect_uri: redirectUri,
    code_challenge_method: 'S256',
    code_challenge: codeChallenge
  });

  window.location = 'https://accounts.spotify.com/authorize?' + args;
}

async function fetchAccessToken(code) {
  const codeVerifier = localStorage.getItem('code_verifier');

  const body = new URLSearchParams({
    client_id: clientId,
    grant_type: 'authorization_code',
    code: code,
    redirect_uri: redirectUri,
    code_verifier: codeVerifier
  });

  const resp = await fetch('https://accounts.spotify.com/api/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: body
  });

  if (!resp.ok) throw new Error("Token request failed");

  const data = await resp.json();
  localStorage.setItem('access_token', data.access_token);
  localStorage.setItem('refresh_token', data.refresh_token);
  localStorage.setItem('token_timestamp', Date.now().toString());
}

async function refreshAccessToken() {
  const refreshToken = localStorage.getItem('refresh_token');
  if (!refreshToken) throw new Error("No refresh token found");

  const body = new URLSearchParams({
    client_id: clientId,
    grant_type: 'refresh_token',
    refresh_token: refreshToken
  });

  const resp = await fetch('https://accounts.spotify.com/api/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: body
  });

  if (!resp.ok) throw new Error("Refresh token request failed");

  const data = await resp.json();
  localStorage.setItem('access_token', data.access_token);
  localStorage.setItem('token_timestamp', Date.now().toString());
}

/* --------- SPOTIFY API CALLS --------- */
async function getAccessToken() {
  let token = localStorage.getItem('access_token');
  const timestamp = parseInt(localStorage.getItem('token_timestamp') || "0", 10);
  
  if (!token) return null;

  // If older than ~55 min, refresh
  if (Date.now() - timestamp > 55 * 60 * 1000) {
    await refreshAccessToken();
    token = localStorage.getItem('access_token');
  }

  return token;
}

async function shuffleQueue() {
  const btn = document.getElementById('shuffleBtn');
  btn.disabled = true;
  btn.classList.remove('success', 'error');

  try {
    const token = await getAccessToken();
    if (!token) throw new Error("No access token");

    // Fetch playlist items
    let allTracks = [];
    let url = `https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=100`;
    while (url) {
      const resp = await fetch(url, { headers: { Authorization: 'Bearer ' + token } });
      if (!resp.ok) throw new Error("Failed fetching playlist");
      const data = await resp.json();
      allTracks.push(...data.items);
      url = data.next;
    }

    // Random indices
    const total = allTracks.length;
    const indices = new Set();
    while (indices.size < 100 && indices.size < total) {
      indices.add(Math.floor(Math.random() * total));
    }

    // Queue tracks
    for (const idx of indices) {
      const uri = allTracks[idx].track.uri;
      const qPost = await fetch(
        'https://api.spotify.com/v1/me/player/queue?uri=' + encodeURIComponent(uri),
        { method: 'POST', headers: { Authorization: 'Bearer ' + token } }
      );
      if (!qPost.ok) throw new Error("Queueing failed");
    }

    btn.classList.add('success');
  } catch (err) {
    console.error(err);
    btn.classList.add('error');
  } finally {
    btn.disabled = false;
  }
}

/* --------- ON PAGE LOAD --------- */
(async function init() {
  const params = new URLSearchParams(window.location.search);

  if (params.has('code')) {
    await fetchAccessToken(params.get('code'));
    window.history.replaceState({}, document.title, redirectUri);
  }

  const token = await getAccessToken();
  if (token) {
    document.getElementById('loginBtn').style.display = 'none';
    document.getElementById('shuffleBtn').style.display = 'inline-block';
    document.getElementById('shuffleBtn').addEventListener('click', shuffleQueue);
  } else {
    document.getElementById('loginBtn').addEventListener('click', loginWithSpotify);
  }
})();
</script>
</body>
</html>
